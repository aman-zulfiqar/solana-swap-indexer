<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Swap Indexer - API Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes pulse-border {
            0%, 100% { border-color: rgb(59 130 246 / 0.5); }
            50% { border-color: rgb(59 130 246 / 0.8); }
        }
        .loading { animation: pulse-border 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .swap-row { transition: all 0.2s ease; }
        .swap-row:hover { transform: translateX(4px); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i data-lucide="activity" class="w-8 h-8 text-blue-500"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Solana Swap Indexer</h1>
                        <p class="text-gray-400 text-sm">Real-time DEX swap monitoring dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div id="status-dot" class="w-3 h-3 bg-gray-500 rounded-full"></div>
                        <span id="status-text" class="text-sm text-gray-400">Checking...</span>
                    </div>
                    <button onclick="checkHealth()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors flex items-center space-x-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- API Configuration -->
        <section class="mb-6">
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <h2 class="text-lg font-semibold mb-3 flex items-center space-x-2">
                    <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
                    <span>API Configuration</span>
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Base URL</label>
                        <input type="text" id="base-url" value="http://localhost:8090" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">API Key</label>
                        <input type="password" id="api-key" value="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" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <section class="mb-6">
            <div class="flex space-x-1 bg-gray-800 p-1 rounded-lg">
                <button onclick="switchTab('swaps')" id="tab-swaps" class="tab-btn flex-1 px-4 py-2 rounded-md transition-colors bg-blue-600 text-white">
                    <i data-lucide="repeat" class="w-4 h-4 inline mr-2"></i>Recent Swaps
                </button>
                <button onclick="switchTab('prices')" id="tab-prices" class="tab-btn flex-1 px-4 py-2 rounded-md transition-colors text-gray-400 hover:text-white">
                    <i data-lucide="dollar-sign" class="w-4 h-4 inline mr-2"></i>Token Prices
                </button>
                <button onclick="switchTab('ai')" id="tab-ai" class="tab-btn flex-1 px-4 py-2 rounded-md transition-colors text-gray-400 hover:text-white">
                    <i data-lucide="brain" class="w-4 h-4 inline mr-2"></i>AI Query
                </button>
                <button onclick="switchTab('flags')" id="tab-flags" class="tab-btn flex-1 px-4 py-2 rounded-md transition-colors text-gray-400 hover:text-white">
                    <i data-lucide="flag" class="w-4 h-4 inline mr-2"></i>Feature Flags
                </button>
            </div>
        </section>

        <!-- Tab Content -->
        <section>
            <!-- Recent Swaps Tab -->
            <div id="content-swaps" class="tab-content">
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold flex items-center space-x-2">
                                <i data-lucide="clock" class="w-5 h-5 text-gray-400"></i>
                                <span>Recent Swap Activity</span>
                            </h3>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-400">Limit:</label>
                                <select id="swaps-limit" class="px-2 py-1 bg-gray-700 border border-gray-600 rounded text-sm">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                                <button onclick="loadRecentSwaps()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition-colors">
                                    Load
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="swaps-loading" class="hidden text-center py-8">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-blue-500"></i>
                            <p class="mt-2 text-gray-400">Loading recent swaps...</p>
                        </div>
                        <div id="swaps-error" class="hidden bg-red-900/20 border border-red-700 rounded-lg p-4">
                            <p class="text-red-400"></p>
                        </div>
                        <div id="swaps-data" class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="text-left py-2 px-2 font-medium text-gray-400">Pair</th>
                                        <th class="text-right py-2 px-2 font-medium text-gray-400">Amount In</th>
                                        <th class="text-right py-2 px-2 font-medium text-gray-400">Amount Out</th>
                                        <th class="text-right py-2 px-2 font-medium text-gray-400">Price</th>
                                        <th class="text-left py-2 px-2 font-medium text-gray-400">Signature</th>
                                    </tr>
                                </thead>
                                <tbody id="swaps-tbody">
                                    <tr>
                                        <td colspan="5" class="text-center py-8 text-gray-500">Click "Load" to fetch recent swaps</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token Prices Tab -->
            <div id="content-prices" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="text-lg font-semibold flex items-center space-x-2">
                            <i data-lucide="trending-up" class="w-5 h-5 text-gray-400"></i>
                            <span>Token Price Lookup</span>
                        </h3>
                    </div>
                    <div class="p-4">
                        <div class="flex space-x-4 mb-4">
                            <input type="text" id="token-symbol" placeholder="Enter token symbol (e.g., SOL, USDC)" 
                                   class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button onclick="loadTokenPrice()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                                Get Price
                            </button>
                        </div>
                        <div id="price-loading" class="hidden text-center py-8">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-blue-500"></i>
                            <p class="mt-2 text-gray-400">Fetching price...</p>
                        </div>
                        <div id="price-error" class="hidden bg-red-900/20 border border-red-700 rounded-lg p-4">
                            <p class="text-red-400"></p>
                        </div>
                        <div id="price-data" class="hidden">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-400">Token</p>
                                        <p class="text-xl font-semibold" id="price-token"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-400">Price</p>
                                        <p class="text-xl font-semibold text-green-400" id="price-value"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Query Tab -->
            <div id="content-ai" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="text-lg font-semibold flex items-center space-x-2">
                            <i data-lucide="brain" class="w-5 h-5 text-gray-400"></i>
                            <span>AI Query Assistant</span>
                        </h3>
                        <p class="text-sm text-gray-400 mt-1">Ask natural language questions about swap data</p>
                    </div>
                    <div class="p-4">
                        <div class="mb-4">
                            <textarea id="ai-question" rows="3" placeholder="e.g., What were the top 5 pairs by total amount_out in the last 24 hours?" 
                                      class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                        </div>
                        <div class="flex space-x-4 mb-4">
                            <button onclick="askAI()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                                Ask AI
                            </button>
                            <button onclick="clearAI()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                                Clear
                            </button>
                        </div>
                        <div id="ai-loading" class="hidden text-center py-8">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-blue-500"></i>
                            <p class="mt-2 text-gray-400">Processing query...</p>
                        </div>
                        <div id="ai-error" class="hidden bg-red-900/20 border border-red-700 rounded-lg p-4">
                            <p class="text-red-400"></p>
                        </div>
                        <div id="ai-data" class="hidden space-y-4">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-medium mb-2 text-gray-300">Generated SQL</h4>
                                <pre class="bg-gray-800 p-3 rounded text-sm overflow-x-auto text-gray-300" id="ai-sql"></pre>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-medium mb-2 text-gray-300">Answer</h4>
                                <div class="text-gray-300" id="ai-answer"></div>
                            </div>
                            <div class="text-sm text-gray-400">
                                <span>Processing time: </span><span id="ai-time"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Flags Tab -->
            <div id="content-flags" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="text-lg font-semibold flex items-center space-x-2">
                            <i data-lucide="flag" class="w-5 h-5 text-gray-400"></i>
                            <span>Feature Flags Management</span>
                        </h3>
                    </div>
                    <div class="p-4">
                        <!-- Create New Flag -->
                        <div class="mb-6">
                            <h4 class="font-medium mb-3">Create New Flag</h4>
                            <div class="flex space-x-4">
                                <input type="text" id="flag-key" placeholder="Flag key (e.g., feature.enabled)" 
                                       class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <select id="flag-value" class="px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                    <option value="true">true</option>
                                    <option value="false">false</option>
                                </select>
                                <button onclick="createFlag()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                                    Create
                                </button>
                            </div>
                        </div>

                        <!-- Flags List -->
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-medium">Existing Flags</h4>
                                <button onclick="loadFlags()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                                    Refresh
                                </button>
                            </div>
                            <div id="flags-loading" class="hidden text-center py-8">
                                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-blue-500"></i>
                                <p class="mt-2 text-gray-400">Loading flags...</p>
                            </div>
                            <div id="flags-error" class="hidden bg-red-900/20 border border-red-700 rounded-lg p-4">
                                <p class="text-red-400"></p>
                            </div>
                            <div id="flags-data" class="space-y-2">
                                <p class="text-center py-8 text-gray-500">Click "Refresh" to load feature flags</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global state
        let currentTab = 'swaps';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkHealth();
        });

        // Tab switching
        function switchTab(tab) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remove active state from all tabs
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-blue-600', 'text-white');
                el.classList.add('text-gray-400');
            });
            
            // Show selected content
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            // Activate selected tab
            const activeTab = document.getElementById(`tab-${tab}`);
            activeTab.classList.add('bg-blue-600', 'text-white');
            activeTab.classList.remove('text-gray-400');
            
            currentTab = tab;
        }

        // API helpers
        function getHeaders() {
            const apiKey = document.getElementById('api-key').value;
            return {
                'Content-Type': 'application/json',
                ...(apiKey && { 'X-API-Key': apiKey })
            };
        }

        function getBaseUrl() {
            return document.getElementById('base-url').value;
        }

        async function apiCall(endpoint, options = {}) {
            const url = `${getBaseUrl()}${endpoint}`;
            const response = await fetch(url, {
                headers: getHeaders(),
                ...options
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error || `HTTP ${response.status}`);
            }
            
            return response.json();
        }

        // Health check
        async function checkHealth() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            try {
                await apiCall('/v1/health');
                statusDot.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = 'Connected';
                statusText.className = 'text-sm text-green-400';
            } catch (error) {
                statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'Disconnected';
                statusText.className = 'text-sm text-red-400';
            }
        }

        // Recent Swaps
        async function loadRecentSwaps() {
            const loading = document.getElementById('swaps-loading');
            const error = document.getElementById('swaps-error');
            const data = document.getElementById('swaps-data');
            const tbody = document.getElementById('swaps-tbody');
            const limit = document.getElementById('swaps-limit').value;
            
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            data.classList.add('hidden');
            
            try {
                const result = await apiCall(`/v1/swaps/recent?limit=${limit}`);
                loading.classList.add('hidden');
                data.classList.remove('hidden');
                
                if (result.items && result.items.length > 0) {
                    tbody.innerHTML = result.items.map(swap => `
                        <tr class="border-b border-gray-700 swap-row hover:bg-gray-700/50">
                            <td class="py-2 px-2 font-medium">${swap.pair || 'N/A'}</td>
                            <td class="py-2 px-2 text-right">${swap.amount_in ? swap.amount_in.toFixed(4) : 'N/A'} ${swap.token_in || ''}</td>
                            <td class="py-2 px-2 text-right">${swap.amount_out ? swap.amount_out.toFixed(4) : 'N/A'} ${swap.token_out || ''}</td>
                            <td class="py-2 px-2 text-right">${swap.price ? swap.price.toFixed(6) : 'N/A'}</td>
                            <td class="py-2 px-2">
                                <span class="text-xs text-gray-400 font-mono">${swap.signature ? swap.signature.substring(0, 8) + '...' : 'N/A'}</span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No recent swaps found</td></tr>';
                }
            } catch (error) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.querySelector('p').textContent = `Error: ${error.message}`;
            }
        }

        // Token Price
        async function loadTokenPrice() {
            const token = document.getElementById('token-symbol').value.trim();
            if (!token) {
                alert('Please enter a token symbol');
                return;
            }
            
            const loading = document.getElementById('price-loading');
            const error = document.getElementById('price-error');
            const data = document.getElementById('price-data');
            
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            data.classList.add('hidden');
            
            try {
                const result = await apiCall(`/v1/prices/${token.toUpperCase()}`);
                loading.classList.add('hidden');
                data.classList.remove('hidden');
                
                document.getElementById('price-token').textContent = result.token;
                document.getElementById('price-value').textContent = `$${result.price.toFixed(6)}`;
            } catch (error) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.querySelector('p').textContent = `Error: ${error.message}`;
            }
        }

        // AI Query
        async function askAI() {
            const question = document.getElementById('ai-question').value.trim();
            if (!question) {
                alert('Please enter a question');
                return;
            }
            
            const loading = document.getElementById('ai-loading');
            const error = document.getElementById('ai-error');
            const data = document.getElementById('ai-data');
            
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            data.classList.add('hidden');
            
            try {
                const result = await apiCall('/v1/ai/ask', {
                    method: 'POST',
                    body: JSON.stringify({ question })
                });
                
                loading.classList.add('hidden');
                data.classList.remove('hidden');
                
                document.getElementById('ai-sql').textContent = result.sql;
                document.getElementById('ai-answer').textContent = result.answer;
                document.getElementById('ai-time').textContent = `${result.took_ms}ms`;
            } catch (error) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.querySelector('p').textContent = `Error: ${error.message}`;
            }
        }

        function clearAI() {
            document.getElementById('ai-question').value = '';
            document.getElementById('ai-data').classList.add('hidden');
            document.getElementById('ai-error').classList.add('hidden');
        }

        // Feature Flags
        async function createFlag() {
            const key = document.getElementById('flag-key').value.trim();
            const value = document.getElementById('flag-value').value === 'true';
            
            if (!key) {
                alert('Please enter a flag key');
                return;
            }
            
            try {
                await apiCall('/v1/flags', {
                    method: 'POST',
                    body: JSON.stringify({ key, value })
                });
                
                document.getElementById('flag-key').value = '';
                loadFlags();
            } catch (error) {
                alert(`Error creating flag: ${error.message}`);
            }
        }

        async function loadFlags() {
            const loading = document.getElementById('flags-loading');
            const error = document.getElementById('flags-error');
            const data = document.getElementById('flags-data');
            
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            
            try {
                const result = await apiCall('/v1/flags');
                loading.classList.add('hidden');
                
                if (result.items && result.items.length > 0) {
                    data.innerHTML = result.items.map(flag => `
                        <div class="bg-gray-700 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="font-mono text-sm">${flag.key}</span>
                                <span class="px-2 py-1 rounded text-xs font-medium ${
                                    flag.value ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'
                                }">${flag.value}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="updateFlag('${flag.key}', ${!flag.value})" class="px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs transition-colors">
                                    Toggle
                                </button>
                                <button onclick="deleteFlag('${flag.key}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    data.innerHTML = '<p class="text-center py-8 text-gray-500">No feature flags found</p>';
                }
            } catch (error) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.querySelector('p').textContent = `Error: ${error.message}`;
            }
        }

        async function updateFlag(key, value) {
            try {
                await apiCall(`/v1/flags/${key}`, {
                    method: 'PUT',
                    body: JSON.stringify({ value })
                });
                loadFlags();
            } catch (error) {
                alert(`Error updating flag: ${error.message}`);
            }
        }

        async function deleteFlag(key) {
            if (!confirm(`Delete flag "${key}"?`)) return;
            
            try {
                await apiCall(`/v1/flags/${key}`, { method: 'DELETE' });
                loadFlags();
            } catch (error) {
                alert(`Error deleting flag: ${error.message}`);
            }
        }

        // Refresh icons after dynamic content
        const observer = new MutationObserver(() => {
            lucide.createIcons();
        });
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
